<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Echo Chamber ‚Äî Bot Activity Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; padding:20px; background:#f7f9fc;}
    .controls{margin-bottom:12px;}
    input, button{padding:8px 10px; font-size:14px; margin: 4px;}
    .card{background:white; padding:12px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.06); margin-bottom:10px;}
    .muted{color:#666; font-size:0.9rem;}
    .link{color:#0066cc; text-decoration:underline; cursor:pointer;}
    .link:hover{color:#004499;}
    .stats{display:flex; gap:20px; margin:10px 0;}
    .stat{background:#f0f8ff; padding:8px; border-radius:4px; text-align:center;}
    .citation-item{background:#f9f9f9; padding:8px; margin:4px 0; border-radius:4px; border-left:3px solid #0066cc;}
    .bot-edit{background:#ffe6e6; border-left-color:#cc0000;}
    .human-edit{background:#e6ffe6; border-left-color:#00cc00;}
  </style>
</head>
<body>
  <h2>Echo Chamber ‚Äî Live Bot Activity & Citation Changes</h2>
  <div class="controls card">
    <div style="margin-bottom: 10px;">
      <label>Search query: <input id="query" value="AI-generated content Wikipedia" style="width:320px"></label>
    </div>
    <div style="margin-bottom: 10px;">
      <label>Pages to analyze: <input id="pages" value="3" style="width:60px" min="1" max="10"></label>
      <label>Revisions per page: <input id="revs" value="30" style="width:60px" min="5" max="100"></label>
    </div>
    <button id="run">üîç Analyze Wikipedia Pages</button>
    <div id="status" class="muted">Ready to analyze</div>
  </div>

  <div id="results"></div>

  <script>
    const runBtn = document.getElementById('run')
    const status = document.getElementById('status')
    runBtn.onclick = async () => {
      const q = encodeURIComponent(document.getElementById('query').value)
      const pages = document.getElementById('pages').value
      const revs = document.getElementById('revs').value
      status.textContent = 'Fetching‚Ä¶'
      const res = await fetch(`/api/summary?query=${q}&pages=${pages}&revs=${revs}`)
      const data = await res.json()
      status.textContent = `Got ${data.results.length} pages`
      const container = document.getElementById('results')
      container.innerHTML = ''
      data.results.forEach(r => {
        const el = document.createElement('div')
        el.className = 'card'
        
        // Create clickable page link
        const pageLink = r.page_url ? `<a href="${r.page_url}" target="_blank" class="link">üìñ View Wikipedia Page</a>` : ''
        
        // Create stats display
        const statsHtml = `
          <div class="stats">
            <div class="stat">
              <strong>${r.total_revisions_analyzed}</strong><br>
              <small>Revisions</small>
            </div>
            <div class="stat">
              <strong>${r.bot_edits_count}</strong><br>
              <small>Bot Edits</small>
            </div>
            <div class="stat">
              <strong>${r.bot_edit_percent.toFixed(1)}%</strong><br>
              <small>Bot %</small>
            </div>
            <div class="stat">
              <strong>${r.anonymous_edits_count}</strong><br>
              <small>Anonymous</small>
            </div>
          </div>
        `
        
        // Create citation changes with clickable links
        const citationHtml = r.citation_deltas.length ? 
          r.citation_deltas.map(d => {
            const deltaColor = d.citation_delta > 0 ? 'üü¢' : 'üî¥'
            const revLink = d.rev_url ? `<a href="${d.rev_url}" target="_blank" class="link">View Revision</a>` : ''
            return `
              <div class="citation-item">
                <strong>${deltaColor} ${d.timestamp}</strong><br>
                <small>User: ${d.user} | Comment: ${d.comment || 'No comment'}</small><br>
                <strong>Citation Delta: ${d.citation_delta > 0 ? '+' : ''}${d.citation_delta}</strong> (Total refs: ${d.ref_count})<br>
                ${revLink}
              </div>
            `
          }).join('') : 
          '<div class="muted">No citation changes detected in analyzed revisions</div>'
        
        el.innerHTML = `
          <h3>${r.title}</h3>
          <div class="muted">Page ID: ${r.pageid || 'N/A'} | ${pageLink}</div>
          ${statsHtml}
          <h4>üìä Citation Changes:</h4>
          ${citationHtml}
        `
        container.appendChild(el)
      })
    }

    // auto-run once
    runBtn.click()
  </script>
</body>
</html>
